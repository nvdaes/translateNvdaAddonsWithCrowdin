name: Export add-on to Crowdin

on:

  workflow_dispatch:
    inputs:
      update:
        description: 'true to update preexisting sources, false to add them from scratch'
        type: boolean
        required: false
        default: true
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  crowdinProjectID: ${{ vars.CROWDIN_ID }}
  crowdinAuthToken: ${{ secrets.CROWDIN_TOKEN }}
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout add-on
        uses: actions/checkout@v6
      - name: "Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scons markdown
          sudo apt update
          sudo apt install gettext
      - name: Build add-on and pot file
        run: |
          scons
          scons pot
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7
      - name: Get add-on info
        id: getAddonInfo
        shell: python
        run: |
          import os, sys, json
          sys.path.insert(0, os.getcwd())
          import buildVars, sha256
          addonId = buildVars.addon_info["addon_name"]
          readmeFile = os.path.join(os.getcwd(), "readme.md")
          i18nSources = sorted(buildVars.i18nSources)
          if os.path.isfile(readmeFile):
            readmeSha = sha256.sha256_checksum([readmeFile])
          i18nSourcesSha = sha256.sha256_checksum(i18nSources)
          hashFile = os.path.join(os.getcwd(), "hash.json")
          data = dict()
          if os.path.isfile(hashFile):
            with open(hashFile, "rt") as f:
              data = json.load(f)
          shouldUpdateXliff = (data.get("readmeSha") != readmeSha and data.get("readmeSha") is not None) and os.path.isfile(f"{addonId}.xliff")
          shouldUpdatePot = (data.get("i18nSourcesSha") != i18nSourcesSha and data.get("i18nSourcesSha") is not None)
          data = dict()
          if readmeSha:
            data["readmeSha"] = readmeSha
          if i18nSourcesSha:
            data["i18nSourcesSha"] = i18nSourcesSha
          with open(hashFile, "wt", encoding="utf-8") as f:
            json.dump(data, f, indent="\t", ensure_ascii=False)
          name = 'addonId'
          value = addonId
          name0 = 'shouldUpdateXliff'
          value0 = str(shouldUpdateXliff).lower()
          name1 = 'shouldUpdatePot'
          value1 = str(shouldUpdatePot).lower()
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"{name}={value}\n{name0}={value0}\n{name1}={value1}\n")
      - name: Generate xliff and pot
        if: ${{ !inputs.update }}
        run: |
          uv run ./_l10n/markdownTranslate.py generateXliff -m readme.md -o ${{ steps.getAddonInfo.outputs.addonId }}.xliff
          uv run ./_l10n/l10nUtil.py uploadSourceFile --localFilePath=${{ steps.getAddonInfo.outputs.addonId }}.xliff
          uv run ./_l10n/l10nUtil.py uploadSourceFile --localFilePath=${{ steps.getAddonInfo.outputs.addonId }}.pot
      - name: update xliff
        if: ${{ inputs.update && steps.getAddonInfo.outputs.shouldUpdateXliff == 'true' }}
        run: |
          uv run ./_l10n/markdownTranslate.py updateXliff -x ${{ steps.getAddonInfo.outputs.addonId }}.xliff -m readme.md -o ${{ steps.getAddonInfo.outputs.addonId }}.xliff.temp
          mv ${{ steps.getAddonInfo.outputs.addonId }}.xliff.temp ${{ steps.getAddonInfo.outputs.addonId }}.xliff
          uv run ./_l10n/crowdinSync.py uploadSourceFile ${{ steps.getAddonInfo.outputs.addonId }}.xliff
      - name: Update pot
        if: ${{ inputs.update && steps.getAddonInfo.outputs.shouldUpdatePot == 'true' }}
        run: |
          uv run ./_l10n/crowdinSync.py uploadSourceFile ${{ steps.getAddonInfo.outputs.addonId }}.pot
      - name: Commit and push json and xliff files
        id: commit
        run: |
          git config --local user.name github-actions
          git config --local user.email github-actions@github.com
          git status
          git add hash.json _l10n/l10n.json ${{ steps.getAddonInfo.outputs.addonId}}.xliff
          if git diff --staged --quiet; then
          echo "Nothing added to commit."
          else
          git commit -m "Update Crowdin file ids and hashes"
          git push
          fi
